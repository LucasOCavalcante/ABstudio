<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AB Studio — Sistema Completo (HTML + JS + CSS)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--ok:#10b981;--danger:#ef4444}
    *{box-sizing:border-box;font-family:Inter, system-ui, Arial, sans-serif}
    body{margin:0;background:linear-gradient(180deg,#081023 0%, #071227 100%);color:#e6eef6}
    header{display:flex;align-items:center;gap:16px;padding:18px 24px;background:rgba(255,255,255,0.02);border-bottom:1px solid rgba(255,255,255,0.03)}
    header h1{font-size:18px;margin:0}
    .container{display:grid;grid-template-columns:260px 1fr;gap:20px;padding:20px;min-height:calc(100vh - 72px)}
    nav{background:var(--card);padding:16px;border-radius:12px;height:fit-content}
    nav button{display:block;width:100%;text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;color:var(--muted);margin-bottom:8px}
    nav button.active{background:linear-gradient(90deg, rgba(6,182,212,0.12), rgba(6,182,212,0.06));color:var(--accent)}
    .card{background:var(--card);padding:16px;border-radius:12px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select, textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left;font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .actions button{margin-right:6px}
    .btn{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#042027;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .danger{background:var(--danger);color:white}
    .ok{background:var(--ok);color:#05251a}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    footer{padding:12px 24px;color:var(--muted);font-size:13px}
    .search{display:flex;gap:8px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px}
    .expiring{color:var(--danger);font-weight:600}
    .expired{color:var(--danger);font-weight:800}
    .green{color:var(--ok)}
    .list{max-height:60vh;overflow:auto}
    .top-stats{display:flex;gap:12px}
    .stat{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent)}
    @media(max-width:900px){.container{grid-template-columns:1fr;}nav{position:sticky;top:0;z-index:10}}
  </style>
</head>
<body>
  <header>
    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect rx='8' width='36' height='36' fill='%2306b6d4'/><text x='50%' y='58%' font-size='18' text-anchor='middle' fill='white' font-family='Arial'>AB</text></svg>" alt="logo" style="width:36px;height:36px;border-radius:8px;">
    <h1>AB Studio — Sistema Completo (HTML + JS + CSS)</h1>
    <div style="flex:1"></div>
    <div class="small">Dados salvos em <span id="storageKey"></span></div>
  </header>

  <div class="container">
    <nav class="card">
      <button class="active" data-view="dashboard">Dashboard</button>
      <button data-view="clients">Clientes</button>
      <button data-view="packages">Pacotes</button>
      <button data-view="sales">Vendas / Orçamentos</button>
      <button data-view="transactions">Entradas / Saídas</button>
      <button data-view="reports">Relatórios</button>
      <button data-view="backup">Backup / Importar</button>
      <div style="height:1px;background:rgba(255,255,255,0.02);margin:12px 0"></div>
      <button data-view="settings" class="ghost">Configurações</button>
    </nav>

    <main>
      <!-- DASHBOARD -->
      <section id="view-dashboard" class="card view">
        <div class="flex-between">
          <h2>Dashboard</h2>
          <div>
            <button class="btn" onclick="newClientSample()">Adicionar cliente demo</button>
            <button class="btn ghost" onclick="resetDemo()">Reset demo</button>
          </div>
        </div>
        <div class="top-stats" style="margin-top:12px">
          <div class="stat">
            <div class="small">Clientes</div>
            <div id="stat-clients" style="font-size:20px;font-weight:700">0</div>
          </div>
          <div class="stat">
            <div class="small">Pacotes ativos</div>
            <div id="stat-active-packages" style="font-size:20px;font-weight:700">0</div>
          </div>
          <div class="stat">
            <div class="small">Receita (entradas)</div>
            <div id="stat-revenue" style="font-size:20px;font-weight:700">R$ 0,00</div>
          </div>
        </div>

        <div style="margin-top:16px">
          <h3>Próximas expirações</h3>
          <div class="card list" id="expirations"></div>
        </div>
      </section>

      <!-- CLIENTS -->
      <section id="view-clients" class="card view" style="display:none">
        <div class="flex-between">
          <h2>Clientes</h2>
          <div>
            <button class="btn" onclick="openClientForm()">Novo cliente</button>
            <input id="search-client" placeholder="Buscar cliente" style="margin-left:8px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit"> 
          </div>
        </div>
        <div style="margin-top:12px" id="clients-list"></div>
      </section>

      <!-- PACKAGES -->
      <section id="view-packages" class="card view" style="display:none">
        <div class="flex-between">
          <h2>Pacotes</h2>
          <div>
            <button class="btn" onclick="openPackageForm()">Novo pacote</button>
          </div>
        </div>
        <div style="margin-top:12px" id="packages-list"></div>
      </section>

      <!-- SALES ORÇAMENTOS -->
      <section id="view-sales" class="card view" style="display:none">
        <div class="flex-between">
          <h2>Vendas / Orçamentos</h2>
          <div>
            <button class="btn" onclick="openSaleForm('sale')">Registrar venda</button>
            <button class="btn ghost" onclick="openSaleForm('quote')">Criar orçamento</button>
          </div>
        </div>
        <div style="margin-top:12px" id="sales-list"></div>
      </section>

      <!-- TRANSACTIONS -->
      <section id="view-transactions" class="card view" style="display:none">
        <div class="flex-between">
          <h2>Entradas / Saídas</h2>
          <div>
            <button class="btn" onclick="openTransactionForm()">Nova transação</button>
          </div>
        </div>
        <div style="margin-top:12px" id="transactions-list"></div>
      </section>

      <!-- REPORTS -->
      <section id="view-reports" class="card view" style="display:none">
        <div class="flex-between">
          <h2>Relatórios</h2>
          <div>
            <button class="btn" onclick="exportCSVReport()">Exportar CSV</button>
            <button class="btn ghost" onclick="exportFullReportPDF()">Exportar PDF (relatório)</button>
          </div>
        </div>
        <div style="margin-top:12px">
          <h3>Resumo</h3>
          <div id="report-summary"></div>
        </div>
      </section>

      <!-- BACKUP -->
      <section id="view-backup" class="card view" style="display:none">
        <h2>Backup / Importar / Exportar</h2>
        <p class="small">Faça backup manual, exporte dados (JSON/CSV) e importe quando necessário.</p>
        <div style="margin-top:12px" class="row">
          <div class="col">
            <label>Exportar backup (JSON)</label>
            <div class="row"><button class="btn" onclick="exportJSON()">Baixar backup (.json)</button><button class="btn ghost" onclick="downloadSample()">Baixar modelo de import</button></div>
          </div>
          <div class="col">
            <label>Importar backup (.json)</label>
            <input type="file" id="import-file" accept="application/json" onchange="importJSON(event)">
          </div>
        </div>
        <div style="margin-top:12px">
          <label>Exportar PDF / imprimir recibos ou relatório</label>
          <div class="row"><button class="btn" onclick="printAllReceipts()">Imprimir todos recibos</button><button class="btn ghost" onclick="exportFullReportPDF()">Exportar relatório em PDF</button></div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="view-settings" class="card view" style="display:none">
        <h2>Configurações</h2>
        <label>Nome do estúdio</label>
        <input id="studioName">
        <label>Chave de armazenamento</label>
        <input id="storageKeyInput">
        <div style="margin-top:12px">
          <button class="btn" onclick="saveSettings()">Salvar</button>
        </div>
      </section>

    </main>
  </div>

  <footer>AB Studio — Gerenciamento local (funciona diretamente abrindo o arquivo no navegador). Impressão usa a função de impressão do navegador para gerar PDFs.</footer>

  <!-- Modals / Forms hidden areas -->
  <div id="forms" style="display:none">
    <div id="client-form">
      <h3>Novo Cliente</h3>
      <label>Nome</label><input id="client-name">
      <label>Email</label><input id="client-email">
      <label>Telefone</label><input id="client-phone">
      <label>Observações</label><textarea id="client-notes"></textarea>
      <div style="margin-top:8px"><button class="btn" onclick="saveClient()">Salvar cliente</button></div>
    </div>

    <div id="package-form">
      <h3>Novo Pacote</h3>
      <label>Nome do pacote</label><input id="package-name">
      <label>Preço (R$)</label><input id="package-price" type="number" step="0.01">
      <label>Itens (separe por vírgula)</label><input id="package-items">
      <label>Validade (dias) - 0 = sem validade</label><input id="package-days" type="number">
      <div style="margin-top:8px"><button class="btn" onclick="savePackage()">Salvar pacote</button></div>
    </div>

    <div id="sale-form">
      <h3>Venda / Orçamento</h3>
      <label>Tipo</label>
      <select id="sale-type"><option value="sale">Venda</option><option value="quote">Orçamento</option></select>
      <label>Cliente</label>
      <select id="sale-client"></select>
      <label>Pacote</label>
      <select id="sale-package"></select>
      <label>Data</label><input id="sale-date" type="date">
      <label>Preço final (R$)</label><input id="sale-price" type="number" step="0.01">
      <label>Observações</label><textarea id="sale-notes"></textarea>
      <div style="margin-top:8px"><button class="btn" onclick="saveSale()">Salvar</button></div>
    </div>

    <div id="transaction-form">
      <h3>Nova Transação</h3>
      <label>Tipo</label>
      <select id="tx-type"><option value="in">Entrada</option><option value="out">Saída</option></select>
      <label>Valor (R$)</label><input id="tx-amount" type="number" step="0.01">
      <label>Categoria</label><input id="tx-category">
      <label>Data</label><input id="tx-date" type="date">
      <label>Descrição</label><textarea id="tx-desc"></textarea>
      <div style="margin-top:8px"><button class="btn" onclick="saveTransaction()">Salvar transação</button></div>
    </div>
  </div>

  <!-- jsPDF from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const DEFAULT_KEY = 'abstudio_data_v2';
    let STORAGE_KEY = DEFAULT_KEY;
    const storageKeyEl = document.getElementById('storageKey');

    const defaultData = {
      meta:{studioName:'AB Studio'},
      clients:[],
      packages:[],
      sales:[],
      transactions:[]
    };
    let db = JSON.parse(JSON.stringify(defaultData));

    function saveToLocal(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
      renderAll();
    }
    function loadFromLocal(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){ try{ db = JSON.parse(raw); } catch(e){ db = JSON.parse(JSON.stringify(defaultData)); } }
      else db = JSON.parse(JSON.stringify(defaultData));
      storageKeyEl.textContent = STORAGE_KEY;
      renderAll();
    }

    function uid(prefix='id'){return prefix+'_'+Math.random().toString(36).slice(2,9)}
    function money(v){return 'R$ '+Number(v||0).toFixed(2).replace('.',',')}
    function todayISO(){const d=new Date();d.setMinutes(d.getMinutes()-d.getTimezoneOffset());return d.toISOString().slice(0,10)}

    // Navigation
    document.querySelectorAll('nav button').forEach(b=>b.addEventListener('click',()=>{
      document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const view = b.getAttribute('data-view');
      document.querySelectorAll('.view').forEach(v=>v.style.display='none');
      document.getElementById('view-'+view).style.display='block';
      if(view==='clients'){document.getElementById('search-client').focus()}
      renderAll();
    }));

    // Modals
    function openModal(html){
      const modal = document.createElement('div');
      modal.style.position='fixed';modal.style.left='0';modal.style.top='0';modal.style.width='100%';modal.style.height='100%';
      modal.style.display='flex';modal.style.alignItems='center';modal.style.justifyContent='center';modal.style.background='rgba(0,0,0,0.6)';modal.id='appModal';
      const box=document.createElement('div');box.style.width='720px';box.style.maxWidth='95%';box.style.background='var(--card)';box.style.padding='16px';box.style.borderRadius='12px';box.innerHTML=html;
      const close=document.createElement('button');close.textContent='Fechar';close.className='btn ghost';close.style.marginTop='10px';close.onclick=()=>modal.remove();
      box.appendChild(close);modal.appendChild(box);document.body.appendChild(modal);
    }
    function closeModal(){document.getElementById('appModal')?.remove()}

    // CLIENTS
    function openClientForm(data){
      const html = document.getElementById('client-form').innerHTML;
      openModal(html);
      if(data){document.getElementById('client-name').value=data.name||'';document.getElementById('client-email').value=data.email||'';document.getElementById('client-phone').value=data.phone||'';document.getElementById('client-notes').value=data.notes||'';document.getElementById('client-form').dataset.editId=data.id}
    }
    function saveClient(){
      const name=document.getElementById('client-name').value.trim();
      if(!name){alert('Nome obrigatório');return}
      const email=document.getElementById('client-email').value.trim();
      const phone=document.getElementById('client-phone').value.trim();
      const notes=document.getElementById('client-notes').value.trim();
      const editId=document.getElementById('client-form').dataset.editId;
      if(editId){ const c=db.clients.find(x=>x.id===editId); Object.assign(c,{name,email,phone,notes}); }
      else db.clients.push({id:uid('client'),name,email,phone,notes,joined:todayISO()});
      saveToLocal();closeModal();
    }
    function renderClients(){
      const list = document.getElementById('clients-list');
      const q = document.getElementById('search-client')?.value?.toLowerCase()||'';
      if(db.clients.length===0){list.innerHTML='<div class=\"small\">Nenhum cliente cadastrado</div>';return}
      let html='<table><thead><tr><th>Nome</th><th>Contato</th><th>Pacotes</th><th></th></tr></thead><tbody>';
      db.clients.filter(c=>c.name.toLowerCase().includes(q) || (c.email||'').toLowerCase().includes(q) || (c.phone||'').toLowerCase().includes(q)).forEach(c=>{
        const clientSales = db.sales.filter(s=>s.clientId===c.id && s.type==='sale');
        const activePackages = clientSales.filter(s=>!s.expiresAt || new Date(s.expiresAt) > new Date());
        html += `<tr><td><strong>${c.name}</strong><div class=\"small\">${c.email||''} ${c.phone?'<br>'+c.phone:''}</div></td><td class=\"small\">${c.notes||''}</td><td>${activePackages.length} ativo(s)</td><td class=\"actions small\"><button onclick=\"editClient('${c.id}')\" class=\"btn ghost\">Editar</button><button onclick=\"assignPackage('${c.id}')\" class=\"btn\">Vincular pacote</button></td></tr>`;
      });
      html+='</tbody></table>';
      list.innerHTML=html;
    }
    function editClient(id){const c=db.clients.find(x=>x.id===id);openClientForm(c)}
    function assignPackage(clientId){
      if(db.packages.length===0){alert('Nenhum pacote cadastrado');return}
      const packagesOptions = db.packages.map(p=>`<option value=\"${p.id}\">${p.name} — ${money(p.price)}</option>`).join('');
      const html = `<h3>Vincular pacote</h3><label>Cliente</label><div>${db.clients.find(c=>c.id===clientId).name}</div><label>Pacote</label><select id=\"assign-package\">${packagesOptions}</select><label>Data de início</label><input type=\"date\" id=\"assign-date\" value=\"${todayISO()}\"><label>Preço negociado</label><input id=\"assign-price\" type=\"number\" step=\"0.01\"><div style=\"margin-top:8px\"><button class=\"btn\" onclick=\"confirmAssign('${clientId}')\">Confirmar</button></div>`;
      openModal(html);
    }
    function confirmAssign(clientId){
      const pid=document.getElementById('assign-package').value;const date=document.getElementById('assign-date').value||todayISO();const price=document.getElementById('assign-price').value||db.packages.find(p=>p.id===pid).price||0;
      const pack=db.packages.find(p=>p.id===pid);
      const sale={id:uid('sale'),type:'sale',clientId,packageId:pid,price:parseFloat(price),date:date,notes:'',createdAt:new Date().toISOString()};
      if(pack.days && Number(pack.days)>0){const d=new Date(date);d.setDate(d.getDate()+Number(pack.days));sale.expiresAt=d.toISOString().slice(0,10);}
      db.sales.push(sale);saveToLocal();closeModal();autoExportReceiptPDF(sale.id);
    }

    // PACKAGES
    function openPackageForm(data){const html=document.getElementById('package-form').innerHTML;openModal(html);if(data){document.getElementById('package-name').value=data.name;document.getElementById('package-price').value=data.price;document.getElementById('package-items').value=(data.items||[]).join(', ');document.getElementById('package-days').value=data.days||0;document.getElementById('package-form').dataset.editId=data.id}}
    function savePackage(){const name=document.getElementById('package-name').value.trim();if(!name){alert('Nome do pacote obrigatório');return}const price=parseFloat(document.getElementById('package-price').value||0);const items=document.getElementById('package-items').value.split(',').map(x=>x.trim()).filter(x=>x);const days=parseInt(document.getElementById('package-days').value||0);
      const editId=document.getElementById('package-form').dataset.editId;
      if(editId){const p=db.packages.find(x=>x.id===editId);Object.assign(p,{name,price,items,days});}else{db.packages.push({id:uid('pack'),name,price,items,days});}
      saveToLocal();closeModal();}
    function renderPackages(){const list=document.getElementById('packages-list');if(db.packages.length===0){list.innerHTML='<div class=\"small\">Nenhum pacote</div>';return}
      let html='<table><thead><tr><th>Pacote</th><th>Preço</th><th>Itens</th><th>Validade (dias)</th><th></th></tr></thead><tbody>';
      db.packages.forEach(p=>{html+=`<tr><td><strong>${p.name}</strong></td><td>${money(p.price)}</td><td class=\"small\">${p.items.join(', ')}</td><td>${p.days||'—'}</td><td class=\"actions small\"><button class=\"btn ghost\" onclick=\"editPackage('${p.id}')\">Editar</button><button class=\"btn\" onclick=\"deletePackage('${p.id}')\">Excluir</button></td></tr>`});
      html+='</tbody></table>';list.innerHTML=html}
    function editPackage(id){const p=db.packages.find(x=>x.id===id);openPackageForm(p)}
    function deletePackage(id){if(!confirm('Excluir pacote?'))return;db.packages=db.packages.filter(x=>x.id!==id);saveToLocal()}

    // SALES/QUOTES
    function openSaleForm(type){const html=document.getElementById('sale-form').innerHTML;openModal(html);document.getElementById('sale-type').value=type||'sale';populateSaleSelects();document.getElementById('sale-date').value=todayISO();}
    function populateSaleSelects(){const selClient=document.getElementById('sale-client');const selPack=document.getElementById('sale-package');selClient.innerHTML='';selPack.innerHTML='';db.clients.forEach(c=>{selClient.innerHTML+=`<option value=\"${c.id}\">${c.name}</option>`});db.packages.forEach(p=>{selPack.innerHTML+=`<option value=\"${p.id}\">${p.name} — ${money(p.price)}</option>`});}
    function saveSale(){const type=document.getElementById('sale-type').value;const clientId=document.getElementById('sale-client').value;const packageId=document.getElementById('sale-package').value;const date=document.getElementById('sale-date').value||todayISO();const price=parseFloat(document.getElementById('sale-price').value||0);const notes=document.getElementById('sale-notes').value||'';const pack=db.packages.find(p=>p.id===packageId);
      if(!clientId || !packageId){alert('Selecione cliente e pacote');return}
      const sale={id:uid('sale'),type,clientId,packageId,price:price||pack.price,date,notes};
      if(pack.days && Number(pack.days)>0){const d=new Date(date);d.setDate(d.getDate()+Number(pack.days));sale.expiresAt=d.toISOString().slice(0,10)}
      db.sales.push(sale);saveToLocal();closeModal();if(type==='sale')autoExportReceiptPDF(sale.id);
    }
    function renderSales(){const list=document.getElementById('sales-list');if(db.sales.length===0){list.innerHTML='<div class=\"small\">Nenhuma venda ou orçamento</div>';return}
      let html='<table><thead><tr><th>Tipo</th><th>Cliente</th><th>Pacote</th><th>Valor</th><th>Data</th><th></th></tr></thead><tbody>';
      db.sales.slice().reverse().forEach(s=>{const client=db.clients.find(c=>c.id===s.clientId)||{};const pack=db.packages.find(p=>p.id===s.packageId)||{};const status=(s.expiresAt? (new Date(s.expiresAt) < new Date() ? '<span class=\"expired\">Expirado</span>' : '<span class=\"green\">Ativo</span>') : '—'); html+=`<tr><td>${s.type==='sale'?'<span class=\"badge\">Venda</span>':'<span class=\"badge\">Orçamento</span>'}</td><td>${client.name||'—'}</td><td>${pack.name||'—'}</td><td>${money(s.price)}</td><td class=\"small\">${s.date} ${status}</td><td class=\"actions small\"><button class=\"btn ghost\" onclick=\"printReceipt('${s.id}')\">Recibo</button><button class=\"btn\" onclick=\"deleteSale('${s.id}')\">Excluir</button></td></tr>`});
      html+='</tbody></table>';list.innerHTML=html}
    function deleteSale(id){if(!confirm('Excluir essa venda/orçamento?'))return;db.sales=db.sales.filter(s=>s.id!==id);saveToLocal()}

    // TRANSACTIONS
    function openTransactionForm(){const html=document.getElementById('transaction-form').innerHTML;openModal(html);document.getElementById('tx-date').value=todayISO();}
    function saveTransaction(){const type=document.getElementById('tx-type').value;const amount=parseFloat(document.getElementById('tx-amount').value||0);const category=document.getElementById('tx-category').value||'';const date=document.getElementById('tx-date').value||todayISO();const desc=document.getElementById('tx-desc').value||''; if(!amount){alert('Valor obrigatório');return}db.transactions.push({id:uid('tx'),type,amount,category,date,desc});saveToLocal();closeModal()}
    function renderTransactions(){const list=document.getElementById('transactions-list');if(db.transactions.length===0){list.innerHTML='<div class=\"small\">Nenhuma transação</div>';return}
      let html='<table><thead><tr><th>Tipo</th><th>Valor</th><th>Categoria</th><th>Data</th><th>Descrição</th></tr></thead><tbody>';
      db.transactions.slice().reverse().forEach(t=>{html+=`<tr><td>${t.type==='in'?'<span class=\"badge\">Entrada</span>':'<span class=\"badge\">Saída</span>'}</td><td>${money(t.amount)}</td><td>${t.category||'—'}</td><td class=\"small\">${t.date}</td><td class=\"small\">${t.desc||''}</td></tr>`});
      html+='</tbody></table>';list.innerHTML=html}

    // REPORTS
    function generateReport(){
      const totalClients=db.clients.length;
      const totalRevenue = db.transactions.filter(t=>t.type==='in').reduce((a,b)=>a+b.amount,0) + db.sales.filter(s=>s.type==='sale').reduce((a,b)=>a+Number(b.price||0),0);
      const totalExpenses = db.transactions.filter(t=>t.type==='out').reduce((a,b)=>a+b.amount,0);
      const activePackages=db.sales.filter(s=>!s.expiresAt || new Date(s.expiresAt) > new Date()).length;
      return {totalClients,totalRevenue,totalExpenses,activePackages,clients:db.clients.length,sales:db.sales.length,transactions:db.transactions.length};
    }
    function renderReport(){const r=generateReport();document.getElementById('report-summary').innerHTML=`<div class=\"row\"><div class=\"col card\">Clientes: <strong>${r.totalClients}</strong></div><div class=\"col card\">Receita total: <strong>${money(r.totalRevenue)}</strong></div><div class=\"col card\">Despesas: <strong>${money(r.totalExpenses)}</strong></div><div class=\"col card\">Pacotes ativos: <strong>${r.activePackages}</strong></div></div>`}

    function exportCSVReport(){
      let csv='tipo,cliente,pacote,valor,data,notas\\n';
      db.sales.forEach(s=>{const client=db.clients.find(c=>c.id===s.clientId)||{};const pack=db.packages.find(p=>p.id===s.packageId)||{};csv+=`${s.type},\"${client.name||''}\",\"${pack.name||''}\",${s.price},${s.date},\"${(s.notes||'').replace(/\\n/g,' ')}\"\\n`});
      csv+='\\ntransacoes\\n';csv+='tipo,valor,categoria,data,descricao\\n';db.transactions.forEach(t=>{csv+=`${t.type},${t.amount},\"${t.category}\",${t.date},\"${(t.desc||'').replace(/\\n/g,' ')}\"\\n`});
      downloadFile('abstudio_report.csv',csv,'text/csv');
    }

    // BACKUP / IMPORT / EXPORT
    function exportJSON(){downloadFile('abstudio_backup.json',JSON.stringify(db,null,2),'application/json')}
    function downloadSample(){downloadFile('abstudio_sample_import.json',JSON.stringify(defaultData,null,2),'application/json')}
    function importJSON(e){const file = e.target.files[0];if(!file) return; const reader=new FileReader();reader.onload=function(ev){try{const data=JSON.parse(ev.target.result);db=data;saveToLocal();alert('Importação concluída');}catch(err){alert('Arquivo inválido') }};reader.readAsText(file);}
    function downloadFile(filename,content,mime){const a=document.createElement('a');const blob=new Blob([content],{type:mime});a.href=URL.createObjectURL(blob);a.download=filename;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(a.href),5000)}

    // RECEIPTS / PDF (auto export using jsPDF)
    async function autoExportReceiptPDF(saleId){
      const sale = db.sales.find(s=>s.id===saleId); if(!sale) return;
      const client = db.clients.find(c=>c.id===sale.clientId) || {};
      const pack = db.packages.find(p=>p.id===sale.packageId) || {};
      const lines = [
        (db.meta?.studioName || 'AB Studio'),
        'Recibo / Contrato',
        '----------------------------',
        `Cliente: ${client.name||''}`,
        `Email: ${client.email||''}`,
        `Telefone: ${client.phone||''}`,
        `Data: ${sale.date}`,
        ' ',
        `Pacote: ${pack.name||''}`,
        `Itens: ${(pack.items||[]).join(', ')}`,
        `Preço: ${money(sale.price)}`,
        `Validade: ${sale.expiresAt||'Sem validade'}`,
        ' ',
        `Observações: ${(sale.notes||'')}`
      ];
      exportTextAsPDF(lines.join('\\n'), `Recibo_${client.name||sale.id}`);
    }

    function printReceipt(saleId){
      const sale = db.sales.find(s=>s.id===saleId); if(!sale){alert('Venda não encontrada');return}
      const client = db.clients.find(c=>c.id===sale.clientId) || {};
      const pack = db.packages.find(p=>p.id===sale.packageId) || {};
      const html = `
        <div style="font-family:Arial;color:#042027;padding:20px;max-width:800px;margin:0 auto;background:white;">
          <h1>Recibo / Contrato — ${db.meta?.studioName || 'AB Studio'}</h1>
          <div style="display:flex;justify-content:space-between"><div><strong>Cliente:</strong> ${client.name||''}<br>${client.email||''}<br>${client.phone||''}</div><div><strong>Data:</strong> ${sale.date}</div></div>
          <hr>
          <h3>Detalhes</h3>
          <div><strong>Pacote:</strong> ${pack.name||''}</div>
          <div><strong>Itens:</strong> ${(pack.items||[]).join(', ')}</div>
          <div><strong>Preço:</strong> ${money(sale.price)}</div>
          <div><strong>Validade:</strong> ${sale.expiresAt||'Sem validade'}</div>
          <p style="margin-top:12px">${sale.notes||''}</p>
          <div style="margin-top:24px">Assinatura: ____________________________</div>
          <footer style="margin-top:12px;font-size:12px">Emitido por ${db.meta?.studioName||'AB Studio'}</footer>
        </div>
      `;
      const w=window.open('','_blank');w.document.write(html);w.document.close();w.focus();setTimeout(()=>w.print(),300);
    }

    // Export text as PDF using jsPDF (handles long content)
    function exportTextAsPDF(text, filename){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'a4'});
      const margins = { top:40, left:40, right:40 };
      const maxLineWidth = doc.internal.pageSize.getWidth() - margins.left - margins.right;
      const lines = doc.splitTextToSize(text, maxLineWidth);
      let cursorY = margins.top;
      doc.setFontSize(12);
      lines.forEach((line, idx) => {
        if (cursorY > doc.internal.pageSize.getHeight() - 40) { doc.addPage(); cursorY = margins.top; }
        doc.text(line, margins.left, cursorY);
        cursorY += 14;
      });
      doc.save(filename + '.pdf');
    }

    function exportFullReportPDF(){
      const r = generateReport();
      let text = `${db.meta?.studioName || 'AB Studio'} - Relatório\n\n`;
      text += `Clientes cadastrados: ${r.totalClients}\nTotal de vendas: ${db.sales.length}\nTotal de transações: ${db.transactions.length}\nReceita (entradas + vendas): ${money(r.totalRevenue)}\nDespesas: ${money(r.totalExpenses)}\nPacotes ativos: ${r.activePackages}\n\nDetalhes por venda:\n`;
      db.sales.forEach(s => {
        const client = db.clients.find(c=>c.id===s.clientId) || {};
        const pack = db.packages.find(p=>p.id===s.packageId) || {};
        text += `- ${s.type.toUpperCase()} | Cliente: ${client.name||'—'} | Pacote: ${pack.name||'—'} | Valor: ${money(s.price)} | Data: ${s.date}\n`;
      });
      exportTextAsPDF(text, 'Relatorio_AB_Studio');
    }

    function printAllReceipts(){db.sales.forEach(s=>printReceipt(s.id))}

    // SETTINGS
    function saveSettings(){const n=document.getElementById('studioName').value||'AB Studio';const key=document.getElementById('storageKeyInput').value||DEFAULT_KEY;db.meta= db.meta||{};db.meta.studioName=n;STORAGE_KEY=key;localStorage.setItem(STORAGE_KEY, JSON.stringify(db));storageKeyEl.textContent=STORAGE_KEY;alert('Configurações salvas (atenção ao alterar chave: os dados são gravados numa chave diferente)')}

    // DEMO / UTILITIES
    function newClientSample(){
      const c={id:uid('client'),name:'Cliente Demo',email:'cliente@demo.com',phone:'(86) 9 9999-9999',notes:'Cliente gerado para teste',joined:todayISO()};
      db.clients.push(c);
      if(db.packages.length===0){db.packages.push({id:uid('pack'),name:'Pacote Básico',price:500,items:['2 posts/semana','Relatório mensal'],days:30});db.packages.push({id:uid('pack'),name:'Pacote Premium',price:1500,items:['5 posts/semana','Gestão completa','Anúncios'],days:60});}
      saveToLocal();
    }
    function resetDemo(){if(!confirm('Resetar todos os dados para o padrão?'))return;db=JSON.parse(JSON.stringify(defaultData));saveToLocal();}

    // render all
    document.getElementById('search-client').addEventListener('input',renderClients);
    function renderAll(){renderClients();renderPackages();renderSales();renderTransactions();renderReport();renderDashboard();}
    function renderDashboard(){document.getElementById('stat-clients').textContent=db.clients.length;document.getElementById('stat-active-packages').textContent=db.sales.filter(s=>!s.expiresAt || new Date(s.expiresAt)>new Date()).length;const revenue = db.transactions.filter(t=>t.type==='in').reduce((a,b)=>a+b.amount,0)+db.sales.filter(s=>s.type==='sale').reduce((a,b)=>a+Number(b.price||0),0);document.getElementById('stat-revenue').textContent=money(revenue);
      const exEl=document.getElementById('expirations');const today=new Date();let html='';const soon = db.sales.filter(s=>s.expiresAt).sort((a,b)=>new Date(a.expiresAt)-new Date(b.expiresAt)).slice(0,10);
      if(soon.length===0) html='<div class=\"small\">Sem expirações próximas</div>';
      soon.forEach(s=>{const client=db.clients.find(c=>c.id===s.clientId)||{}; const days=Math.ceil((new Date(s.expiresAt)-today)/(1000*60*60*24)); html+=`<div style=\"padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03)\"><strong>${client.name||'—'}</strong> — ${s.expiresAt} <span class=\"small\">(${days} dias)</span></div>`});
      exEl.innerHTML=html;
    }

    // util exposure
    window.db=db;window.saveToLocal=saveToLocal;window.loadFromLocal=loadFromLocal;window.printReceipt=printReceipt;

    // init
    document.getElementById('storageKeyInput').value = STORAGE_KEY;document.getElementById('studioName').value = defaultData.meta.studioName;loadFromLocal();
  </script>
</body>
</html>
